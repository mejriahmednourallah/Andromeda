{% extends "core/dashboard_base.html" %}
{% load static %}

{% block title %}{{ action }} une entr√©e{% endblock %}

{% block extra_head %}
<style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }
    
    .form-container {
        max-width: 1000px;
        margin: 0 auto;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 32px;
        padding: 3.5rem;
        box-shadow: 0 25px 70px rgba(0,0,0,0.1), 0 4px 15px rgba(0,0,0,0.05);
        border: 2px solid rgba(102,126,234,0.15);
        animation: fadeIn 0.7s ease-out;
        position: relative;
        overflow: hidden;
    }
    
    .form-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(102,126,234,0.08), transparent);
        animation: shimmer 4s infinite;
    }
    
    .form-container::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(102,126,234,0.03) 0%, transparent 70%);
        pointer-events: none;
    }
    
    .form-group {
        margin-bottom: 2rem;
        position: relative;
        z-index: 1;
    }
    
    .form-label {
        display: block;
        font-weight: 700;
        margin-bottom: 0.75rem;
        color: #1e293b;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-label::before {
        content: '';
        width: 3px;
        height: 20px;
        background: linear-gradient(180deg, #667eea, #764ba2);
        border-radius: 2px;
    }
    
    .form-input, .form-textarea {
        width: 100%;
        padding: 1.2rem 1.5rem;
        border: 2px solid #e2e8f0;
        border-radius: 20px;
        font-size: 1.1rem;
        font-family: inherit;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    }
    
    .form-input:hover, .form-textarea:hover {
        border-color: #cbd5e1;
        box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }
    
    .form-input:focus, .form-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 5px rgba(102,126,234,0.12), 0 10px 20px rgba(102,126,234,0.18);
        transform: translateY(-3px);
        background: #ffffff;
    }
    
    .form-textarea {
        min-height: 400px;
        resize: vertical;
        line-height: 1.9;
        font-size: 1.1rem;
    }
    
    .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.85rem;
        padding: 1.1rem 1.4rem;
        border: 2px solid #e2e8f0;
        border-radius: 18px;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background: white;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0,0,0,0.02);
    }
    
    .checkbox-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(102,126,234,0.08), rgba(118,75,162,0.08));
        opacity: 0;
        transition: opacity 0.4s ease;
    }
    
    .checkbox-item:hover {
        border-color: #667eea;
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 10px 25px rgba(102,126,234,0.2);
    }
    
    .checkbox-item:hover::before {
        opacity: 1;
    }
    
    .checkbox-item input[type="checkbox"] {
        width: 22px;
        height: 22px;
        cursor: pointer;
        accent-color: #667eea;
        transition: transform 0.2s ease;
    }
    
    .checkbox-item input[type="checkbox"]:checked {
        transform: scale(1.1);
    }
    
    .checkbox-item input:checked ~ span {
        font-weight: 700;
        color: #667eea;
    }
    
    .checkbox-item:has(input:checked) {
        border-color: #667eea;
        background: linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05));
    }
    
    .ai-analyze-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 30%, #f093fb 70%, #4facfe 100%);
        background-size: 300% 300%;
        animation: gradientShift 10s ease infinite;
        color: white;
        border-radius: 32px;
        padding: 3rem;
        margin-bottom: 3rem;
        box-shadow: 0 25px 60px rgba(102,126,234,0.4), 0 10px 25px rgba(0,0,0,0.15);
        position: relative;
        overflow: hidden;
        border: 3px solid rgba(255,255,255,0.2);
    }
    
    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    
    .ai-analyze-section::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
        animation: rotateGlow 25s linear infinite;
    }
    
    @keyframes rotateGlow {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .ai-analyze-section h3,
    .ai-analyze-section p,
    .ai-analyze-section button {
        position: relative;
        z-index: 1;
    }
    
    .ai-analyze-section h3 {
        font-size: 2rem;
        font-weight: 900;
        margin-bottom: 0.85rem;
        text-shadow: 0 4px 8px rgba(0,0,0,0.15);
        letter-spacing: -0.5px;
    }
    
    .ai-analyze-section p {
        font-size: 1.2rem;
        opacity: 0.98;
        margin-bottom: 1.8rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .ai-analyze-section button {
        background: white;
        color: #667eea;
        padding: 1.3rem 3rem;
        border-radius: 60px;
        font-size: 1.2rem;
        font-weight: 800;
        border: none;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 12px 30px rgba(0,0,0,0.2);
        letter-spacing: 0.5px;
    }
    
    .ai-analyze-section button:hover {
        transform: translateY(-5px) scale(1.08);
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
    }
    
    .ai-results {
        background: rgba(255,255,255,0.98);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 2rem;
        margin-top: 2rem;
        display: none;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        border: 2px solid rgba(255,255,255,0.5);
        animation: fadeIn 0.5s ease-out;
    }
    
    .word-count {
        position: fixed;
        bottom: 3rem;
        right: 3rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        color: white;
        padding: 1.5rem 2.5rem;
        border-radius: 60px;
        box-shadow: 0 15px 40px rgba(102,126,234,0.5), 0 5px 15px rgba(0,0,0,0.1);
        font-weight: 800;
        font-size: 1.2rem;
        z-index: 100;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 3px solid rgba(255,255,255,0.3);
        letter-spacing: 0.5px;
        animation: float 3s ease-in-out infinite;
    }
    
    .word-count:hover {
        transform: translateY(-8px) scale(1.08);
        box-shadow: 0 20px 50px rgba(102,126,234,0.6), 0 8px 20px rgba(0,0,0,0.15);
        border-color: rgba(255,255,255,0.5);
    }
    
    .form-actions {
        display: flex;
        gap: 1.5rem;
        justify-content: flex-end;
        margin-top: 3rem;
        padding-top: 2.5rem;
        border-top: 2px solid #e2e8f0;
        position: relative;
        z-index: 1;
    }
    
    .btn-primary, .btn-secondary {
        padding: 1.3rem 3rem;
        border-radius: 60px;
        font-size: 1.2rem;
        font-weight: 800;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        letter-spacing: 0.5px;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        color: white;
        box-shadow: 0 12px 30px rgba(102,126,234,0.4);
        border: 2px solid rgba(255,255,255,0.2);
    }
    
    .btn-primary:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 20px 40px rgba(102,126,234,0.5);
        border-color: rgba(255,255,255,0.4);
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        color: #64748b;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border: 2px solid #e2e8f0;
    }
    
    .btn-secondary:hover {
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        transform: translateY(-3px) scale(1.03);
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        color: #475569;
    }
    
    .section-divider {
        margin: 2.5rem 0;
        height: 2px;
        background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
    }
    
    .btn-template {
        background: white;
        color: #f5576c;
        padding: 0.9rem 1.8rem;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 700;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .btn-template:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 12px 30px rgba(0,0,0,0.25);
        background: linear-gradient(135deg, #ffffff 0%, #fff5f7 100%);
    }
    
    .formatting-toolbar {
        display: flex;
        gap: 0.5rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 16px;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        border: 2px solid #e2e8f0;
    }
    
    .format-btn {
        padding: 0.6rem 1rem;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        color: #64748b;
        font-size: 0.9rem;
    }
    
    .format-btn:hover {
        border-color: #667eea;
        color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102,126,234,0.2);
    }
    
    .format-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
    <div style="margin-bottom: 2rem;">
        <h1 style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">‚úçÔ∏è {{ action }} une entr√©e</h1>
        <p style="color: #6b7280;">Exprimez vos pens√©es et √©motions</p>
    </div>
    
    <!-- Templates Section -->
    <div class="templates-section" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 32px; padding: 2.5rem; margin-bottom: 2rem; box-shadow: 0 20px 50px rgba(245,87,108,0.3); position: relative; overflow: hidden; border: 3px solid rgba(255,255,255,0.2);">
        <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%); animation: rotateGlow 25s linear infinite; pointer-events: none;"></div>
        <h3 style="font-size: 1.8rem; font-weight: 900; margin-bottom: 0.75rem; position: relative; z-index: 1; text-shadow: 0 4px 8px rgba(0,0,0,0.15);">üìã Mod√®les d'Entr√©e</h3>
        <p style="font-size: 1.1rem; opacity: 0.98; margin-bottom: 1.5rem; position: relative; z-index: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">Commencez rapidement avec un mod√®le pr√©d√©fini</p>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; position: relative; z-index: 1;">
            <button type="button" onclick="applyTemplate('gratitude')" class="btn-template">üôè Gratitude</button>
            <button type="button" onclick="applyTemplate('reflection')" class="btn-template">üí≠ R√©flexion</button>
            <button type="button" onclick="applyTemplate('goals')" class="btn-template">üéØ Objectifs</button>
            <button type="button" onclick="applyTemplate('dream')" class="btn-template">üí§ R√™ve</button>
            <button type="button" onclick="applyTemplate('achievement')" class="btn-template">üèÜ R√©ussite</button>
        </div>
    </div>

    <!-- AI Analysis Section - Groq -->
    <div class="ai-analyze-section" style="position: relative; overflow: hidden;">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('data:image/svg+xml,%3Csvg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"none\" fill-rule=\"evenodd\"%3E%3Cg fill=\"%23ffffff\" fill-opacity=\"0.05\"%3E%3Cpath d=\"M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); opacity: 0.3;"></div>
        <div style="position: relative; z-index: 1;">
            <h3 style="font-size: 1.5rem; margin-bottom: 0.75rem; font-weight: 800;">ü§ñ Analyse IA Avanc√©e</h3>
            <p style="opacity: 0.95; margin-bottom: 1.5rem; font-size: 1.1rem; line-height: 1.6;">
                Utilisez l'IA <strong>Groq (LLaMA 3)</strong> pour analyser vos entr√©es:<br>
                ‚Ä¢ D√©tection d'√©motions avanc√©e<br>
                ‚Ä¢ Suggestions de tags intelligentes<br>
                ‚Ä¢ Insights personnalis√©s<br>
                ‚Ä¢ Analyse de tendances
            </p>
            <a href="{% url 'core:page_analyse_ai' %}" class="btn-export" style="display: inline-flex; align-items: center; gap: 0.75rem; text-decoration: none; font-size: 1.1rem;">
                <span style="font-size: 1.5rem;">üöÄ</span>
                Ouvrir l'Analyse IA Groq
            </a>
            <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">
                üí° <em>Sauvegardez d'abord votre entr√©e, puis analysez-la sur la page d√©di√©e</em>
            </p>
        </div>
    </div>
    
    <!-- Auto-save indicator -->
    <div id="autoSaveIndicator" style="position: fixed; top: 2rem; right: 2rem; background: rgba(16, 185, 129, 0.95); color: white; padding: 0.75rem 1.5rem; border-radius: 50px; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4); font-weight: 700; font-size: 0.95rem; z-index: 1000; display: none; animation: fadeIn 0.3s ease-out;">
        ‚úì Sauvegard√© automatiquement
    </div>
    
    <div class="form-container">
        <form method="post" id="entryForm">
            {% csrf_token %}
            
            <!-- Title -->
            <div class="form-group">
                <label class="form-label" for="id_titre">üìù Titre *</label>
                {{ form.titre }}
                {% if form.titre.errors %}
                <p style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">{{ form.titre.errors.0 }}</p>
                {% endif %}
            </div>
            
            <!-- Content -->
            <div class="form-group">
                <label class="form-label" for="id_contenu_texte">‚úçÔ∏è Contenu *</label>
                
                <!-- Formatting Toolbar -->
                <div class="formatting-toolbar">
                    <button type="button" class="format-btn" onclick="formatText('bold')" title="Gras (Ctrl+B)">
                        <strong>B</strong>
                    </button>
                    <button type="button" class="format-btn" onclick="formatText('italic')" title="Italique (Ctrl+I)">
                        <em>I</em>
                    </button>
                    <button type="button" class="format-btn" onclick="formatText('underline')" title="Soulign√© (Ctrl+U)">
                        <u>U</u>
                    </button>
                    <button type="button" class="format-btn" onclick="formatText('heading')" title="Titre">
                        H1
                    </button>
                    <button type="button" class="format-btn" onclick="formatText('list')" title="Liste">
                        ‚Ä¢ Liste
                    </button>
                    <button type="button" class="format-btn" onclick="formatText('quote')" title="Citation">
                        " Citation
                    </button>
                    <button type="button" class="format-btn" onclick="formatText('link')" title="Lien">
                        üîó Lien
                    </button>
                </div>
                
                {{ form.contenu_texte }}
                {% if form.contenu_texte.errors %}
                <p style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">{{ form.contenu_texte.errors.0 }}</p>
                {% endif %}
            </div>
            
            <!-- Location and Weather -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label class="form-label" for="id_lieu">üìç Lieu</label>
                    {{ form.lieu }}
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="id_meteo">üå§Ô∏è M√©t√©o</label>
                    {{ form.meteo }}
                </div>
            </div>
            
            <!-- Tags -->
            <div class="form-group">
                <label class="form-label">üè∑Ô∏è Tags</label>
                <div class="checkbox-grid">
                    {% for tag in form.tags %}
                    <label class="checkbox-item">
                        {{ tag.tag }}
                        <span>{{ tag.choice_label }}</span>
                    </label>
                    {% endfor %}
                </div>
                <a href="{% url 'core:ajouter_tag' %}" style="display: inline-block; margin-top: 0.5rem; color: #3b82f6; font-size: 0.9rem;">+ Cr√©er un nouveau tag</a>
            </div>
            
            <!-- Moods -->
            <div class="form-group">
                <label class="form-label">üòä Humeurs</label>
                <div class="checkbox-grid">
                    {% for humeur in form.humeurs %}
                    <label class="checkbox-item">
                        {{ humeur.tag }}
                        <span>{{ humeur.choice_label }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Options -->
            <div class="form-group">
                <label class="checkbox-item" style="display: inline-flex; max-width: fit-content;">
                    {{ form.is_favorite }}
                    <span>‚≠ê Marquer comme favori</span>
                </label>
            </div>
            
            <div class="form-group">
                <label class="checkbox-item" style="display: inline-flex; max-width: fit-content;">
                    {{ form.is_public }}
                    <span>üåç Rendre public</span>
                </label>
            </div>
            
            <!-- Actions -->
            <div class="form-actions">
                <a href="{% url 'core:liste_entrees_journal' %}" class="btn-secondary">Annuler</a>
                <button type="submit" class="btn-primary">üíæ {{ action }}</button>
            </div>
        </form>
    </div>
    
    <!-- Word Counter -->
    <div class="word-count" id="wordCount">
        0 mots
    </div>
</div>

<script>
// Word counter
const textarea = document.getElementById('id_contenu_texte');
const wordCountEl = document.getElementById('wordCount');

function updateWordCount() {
    const text = textarea.value.trim();
    const words = text ? text.split(/\s+/).length : 0;
    wordCountEl.textContent = words + ' mot' + (words > 1 ? 's' : '');
}

textarea.addEventListener('input', updateWordCount);
updateWordCount();

// Note: L'analyse IA est maintenant disponible sur la page d√©di√©e /journal/ai/
// avec Groq (LLaMA 3) pour des analyses plus avanc√©es et rapides

// Templates
const templates = {
    gratitude: {
        title: "Gratitude du jour",
        content: "Aujourd'hui, je suis reconnaissant(e) pour...\n\n1. \n2. \n3. \n\nCes moments/personnes/choses ont rendu ma journ√©e sp√©ciale parce que..."
    },
    reflection: {
        title: "R√©flexion quotidienne",
        content: "Ce que j'ai appris aujourd'hui :\n\n\nCe qui m'a surpris :\n\n\nCe que je pourrais am√©liorer demain :\n\n\nMes pens√©es principales :"
    },
    goals: {
        title: "Mes objectifs",
        content: "Objectifs √† court terme :\n‚Ä¢ \n‚Ä¢ \n‚Ä¢ \n\nObjectifs √† long terme :\n‚Ä¢ \n‚Ä¢ \n\nActions concr√®tes pour aujourd'hui :\n1. \n2. \n3. "
    },
    dream: {
        title: "Journal de r√™ves",
        content: "Date du r√™ve : \n\nR√©sum√© du r√™ve :\n\n\n√âmotions ressenties :\n\n\nSymboles ou √©l√©ments marquants :\n\n\nInterpr√©tation personnelle :"
    },
    achievement: {
        title: "R√©ussite du jour",
        content: "Ce que j'ai accompli aujourd'hui :\n\n\nLes d√©fis que j'ai surmont√©s :\n\n\nCe dont je suis fier(e) :\n\n\nCe que cela signifie pour moi :"
    }
};

function applyTemplate(templateName) {
    const template = templates[templateName];
    if (template) {
        document.getElementById('id_titre').value = template.title;
        document.getElementById('id_contenu_texte').value = template.content;
        updateWordCount();
        showNotification('‚úì Mod√®le appliqu√© !', 'success');
    }
}

// Text Formatting
function formatText(format) {
    const textarea = document.getElementById('id_contenu_texte');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    let formattedText = selectedText;
    
    switch(format) {
        case 'bold':
            formattedText = `**${selectedText}**`;
            break;
        case 'italic':
            formattedText = `*${selectedText}*`;
            break;
        case 'underline':
            formattedText = `__${selectedText}__`;
            break;
        case 'heading':
            formattedText = `# ${selectedText}`;
            break;
        case 'list':
            formattedText = selectedText.split('\n').map(line => `‚Ä¢ ${line}`).join('\n');
            break;
        case 'quote':
            formattedText = `> ${selectedText}`;
            break;
        case 'link':
            const url = prompt('Entrez l\'URL:');
            if (url) formattedText = `[${selectedText}](${url})`;
            break;
    }
    
    textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
    textarea.focus();
    textarea.setSelectionRange(start, start + formattedText.length);
    updateWordCount();
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        const textarea = document.getElementById('id_contenu_texte');
        if (document.activeElement === textarea) {
            if (e.key === 'b') {
                e.preventDefault();
                formatText('bold');
            } else if (e.key === 'i') {
                e.preventDefault();
                formatText('italic');
            } else if (e.key === 'u') {
                e.preventDefault();
                formatText('underline');
            }
        }
    }
});

// Auto-save functionality
let autoSaveTimeout;
let lastSavedContent = '';

function autoSave() {
    const titre = document.getElementById('id_titre').value;
    const contenu = document.getElementById('id_contenu_texte').value;
    
    // Only save if there's content and it's different from last save
    if ((titre || contenu) && (titre + contenu) !== lastSavedContent) {
        lastSavedContent = titre + contenu;
        
        // Save to localStorage
        localStorage.setItem('journal_draft', JSON.stringify({
            titre: titre,
            contenu: contenu,
            timestamp: new Date().toISOString()
        }));
        
        // Show indicator
        const indicator = document.getElementById('autoSaveIndicator');
        indicator.style.display = 'block';
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 2000);
    }
}

// Trigger auto-save on input
document.getElementById('id_titre').addEventListener('input', function() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(autoSave, 2000); // Save after 2 seconds of inactivity
});

document.getElementById('id_contenu_texte').addEventListener('input', function() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(autoSave, 2000);
});

// Load draft on page load
window.addEventListener('load', function() {
    const draft = localStorage.getItem('journal_draft');
    if (draft) {
        const data = JSON.parse(draft);
        const draftAge = (new Date() - new Date(data.timestamp)) / 1000 / 60; // minutes
        
        // Only restore if draft is less than 24 hours old and fields are empty
        if (draftAge < 1440 && !document.getElementById('id_titre').value && !document.getElementById('id_contenu_texte').value) {
            if (confirm('Un brouillon a √©t√© trouv√©. Voulez-vous le restaurer ?')) {
                document.getElementById('id_titre').value = data.titre;
                document.getElementById('id_contenu_texte').value = data.contenu;
                updateWordCount();
                showNotification('‚úì Brouillon restaur√© !', 'success');
            }
        }
    }
});

// Clear draft on successful submit
document.getElementById('entryForm').addEventListener('submit', function() {
    localStorage.removeItem('journal_draft');
});

// Notification helper
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 2rem;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? 'rgba(16, 185, 129, 0.95)' : 'rgba(239, 68, 68, 0.95)'};
        color: white;
        padding: 1rem 2rem;
        border-radius: 50px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        font-weight: 700;
        z-index: 10000;
        animation: fadeIn 0.3s ease-out;
    `;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 2500);
}
</script>
{% endblock %}

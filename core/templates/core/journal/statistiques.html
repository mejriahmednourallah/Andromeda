{% extends "core/dashboard_base.html" %}
{% load static %}

{% block title %}Statistiques du Journal{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-50px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(50px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 24px;
        padding: 2.5rem 2rem;
        box-shadow: 0 10px 40px rgba(0,0,0,0.06), 0 2px 8px rgba(0,0,0,0.04);
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        animation: fadeInUp 0.6s ease-out;
        border: 2px solid rgba(102,126,234,0.1);
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #4facfe);
        background-size: 200% 100%;
        transform: scaleX(0);
        transition: transform 0.5s ease;
        animation: gradientMove 3s linear infinite;
    }
    
    @keyframes gradientMove {
        0% { background-position: 0% 50%; }
        100% { background-position: 200% 50%; }
    }
    
    .stat-card:hover::before {
        transform: scaleX(1);
    }
    
    .stat-card:hover {
        transform: translateY(-12px) scale(1.02);
        box-shadow: 0 25px 50px rgba(102, 126, 234, 0.2), 0 10px 20px rgba(0,0,0,0.08);
        border-color: rgba(102,126,234,0.3);
    }
    
    .stat-icon {
        font-size: 4.5rem;
        margin-bottom: 1.5rem;
        display: inline-block;
        transition: all 0.4s ease;
        filter: drop-shadow(0 6px 12px rgba(0,0,0,0.15));
        animation: float 3s ease-in-out infinite;
    }
    
    .stat-card:hover .stat-icon {
        transform: scale(1.2) rotate(8deg);
        filter: drop-shadow(0 8px 16px rgba(102,126,234,0.3));
    }
    
    .stat-value {
        font-size: 4rem;
        font-weight: 900;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.75rem;
        line-height: 1;
        text-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .stat-label {
        color: #64748b;
        font-size: 1.15rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1.5px;
    }
    
    .chart-container {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 28px;
        padding: 3rem;
        box-shadow: 0 15px 40px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
        margin-bottom: 2.5rem;
        border: 2px solid rgba(102,126,234,0.1);
        animation: fadeInUp 0.8s ease-out;
        position: relative;
        overflow: hidden;
        transition: all 0.4s ease;
    }
    
    .chart-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 50px rgba(102,126,234,0.15), 0 8px 20px rgba(0,0,0,0.06);
        border-color: rgba(102,126,234,0.2);
    }
    
    .chart-container::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(102,126,234,0.05) 0%, transparent 70%);
        pointer-events: none;
        animation: rotate 30s linear infinite;
    }
    
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .chart-title {
        font-size: 1.9rem;
        font-weight: 800;
        margin-bottom: 2.5rem;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 1rem;
        position: relative;
        z-index: 1;
    }
    
    .chart-title::before {
        content: '';
        width: 5px;
        height: 35px;
        background: linear-gradient(180deg, #667eea, #764ba2, #f093fb);
        border-radius: 3px;
        box-shadow: 0 4px 8px rgba(102,126,234,0.3);
    }
    
    .top-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .top-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .top-list-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 0;
        background: linear-gradient(90deg, rgba(102,126,234,0.1), transparent);
        transition: width 0.3s ease;
    }
    
    .top-list-item:hover::before {
        width: 100%;
    }
    
    .top-list-item:hover {
        background: rgba(102,126,234,0.02);
        transform: translateX(5px);
    }
    
    .top-list-item:last-child {
        border-bottom: none;
    }
    
    .rank {
        font-size: 1.75rem;
        font-weight: 800;
        margin-right: 1.5rem;
        min-width: 40px;
        text-align: center;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .rank.gold { 
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .rank.silver { 
        background: linear-gradient(135deg, #cbd5e1, #94a3b8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .rank.bronze { 
        background: linear-gradient(135deg, #f97316, #ea580c);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .export-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 30%, #f093fb 70%, #4facfe 100%);
        background-size: 300% 300%;
        animation: gradientShift 10s ease infinite;
        color: white;
        border-radius: 32px;
        padding: 4rem 3rem;
        text-align: center;
        margin-bottom: 3rem;
        box-shadow: 0 25px 60px rgba(102,126,234,0.4), 0 10px 25px rgba(0,0,0,0.15);
        position: relative;
        overflow: hidden;
        border: 3px solid rgba(255,255,255,0.2);
    }
    
    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    
    .export-section::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
        animation: rotateGlow 25s linear infinite;
    }
    
    @keyframes rotateGlow {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .export-section h2 {
        font-size: 2.8rem;
        font-weight: 900;
        margin-bottom: 1.2rem;
        text-shadow: 0 6px 12px rgba(0,0,0,0.2);
        position: relative;
        z-index: 1;
        letter-spacing: -0.5px;
    }
    
    .export-section p {
        font-size: 1.3rem;
        opacity: 0.98;
        margin-bottom: 2.5rem;
        position: relative;
        z-index: 1;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn-export {
        background: white;
        color: #667eea;
        padding: 1.5rem 3.5rem;
        border-radius: 60px;
        font-size: 1.2rem;
        font-weight: 800;
        border: none;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 12px 30px rgba(0,0,0,0.2);
        position: relative;
        z-index: 1;
        text-decoration: none;
        display: inline-block;
        letter-spacing: 0.5px;
    }
    
    .btn-export:hover {
        transform: translateY(-5px) scale(1.08);
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
    }
    
    .recent-entries {
        display: grid;
        gap: 1.5rem;
    }
    
    .recent-entry-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        border-left: 4px solid #667eea;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    
    .recent-entry-card:hover {
        transform: translateX(8px);
        box-shadow: 0 8px 20px rgba(102,126,234,0.15);
    }
    
    .recent-entry-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }
    
    .recent-entry-date {
        color: #64748b;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Animated Background -->
<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -1; overflow: hidden; background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 50%, #fce7f3 100%);">
    <div style="position: absolute; width: 500px; height: 500px; border-radius: 50%; background: radial-gradient(circle, rgba(102,126,234,0.15) 0%, transparent 70%); top: -250px; right: -250px; animation: float 20s ease-in-out infinite;"></div>
    <div style="position: absolute; width: 400px; height: 400px; border-radius: 50%; background: radial-gradient(circle, rgba(245,87,108,0.12) 0%, transparent 70%); bottom: -200px; left: -200px; animation: float 25s ease-in-out infinite reverse;"></div>
    <div style="position: absolute; width: 300px; height: 300px; border-radius: 50%; background: radial-gradient(circle, rgba(79,172,254,0.1) 0%, transparent 70%); top: 50%; left: 50%; transform: translate(-50%, -50%); animation: float 30s ease-in-out infinite;"></div>
</div>

<div style="max-width: 1400px; margin: 0 auto; padding: 2rem;">
    <!-- Header with Glassmorphism -->
    <div style="background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); border-radius: 32px; padding: 3rem; margin-bottom: 3rem; box-shadow: 0 20px 60px rgba(0,0,0,0.08); border: 2px solid rgba(255,255,255,0.9); display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="font-size: 3rem; font-weight: 900; margin-bottom: 0.75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: -1px;">📊 Statistiques du Journal</h1>
            <p style="color: #64748b; font-size: 1.2rem; font-weight: 500;">Analysez vos habitudes d'écriture et vos émotions</p>
        </div>
        <a href="{% url 'core:liste_entrees_journal' %}" style="padding: 1rem 2.5rem; border-radius: 50px; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); color: #475569; font-weight: 700; text-decoration: none; box-shadow: 0 8px 20px rgba(0,0,0,0.08); transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 30px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.08)'">← Retour au journal</a>
    </div>

<!-- Export Section with Enhanced Design -->
<div class="export-section" style="position: relative; overflow: hidden;">
    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('data:image/svg+xml,%3Csvg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"none\" fill-rule=\"evenodd\"%3E%3Cg fill=\"%23ffffff\" fill-opacity=\"0.05\"%3E%3Cpath d=\"M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); opacity: 0.3;"></div>
    <h2 style="font-size: 2.2rem; margin-bottom: 1rem; position: relative; z-index: 1;">📄 Exporter votre journal</h2>
    <p style="margin-bottom: 2rem; opacity: 0.98; font-size: 1.2rem; position: relative; z-index: 1;">Téléchargez toutes vos entrées au format PDF</p>
    <button onclick="exportToPDF()" class="btn-export" style="position: relative; z-index: 1;">
        📥 Télécharger en PDF
    </button>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">📝</div>
        <div class="stat-value">{{ total_entrees }}</div>
        <div class="stat-label">Entrées totales</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">✍️</div>
        <div class="stat-value">{{ total_mots|floatformat:0 }}</div>
        <div class="stat-label">Mots écrits</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">⭐</div>
        <div class="stat-value">{{ entrees_favorites }}</div>
        <div class="stat-label">Entrées favorites</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">📊</div>
        <div class="stat-value">{{ moyenne_mots }}</div>
        <div class="stat-label">Mots par entrée</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-color: rgba(245,87,108,0.3);">
        <div class="stat-icon">🔥</div>
        <div class="stat-value" style="-webkit-text-fill-color: white; background: none;">{{ current_streak }}</div>
        <div class="stat-label" style="color: rgba(255,255,255,0.95);">Série actuelle (jours)</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border-color: rgba(79,172,254,0.3);">
        <div class="stat-icon">🏆</div>
        <div class="stat-value" style="-webkit-text-fill-color: white; background: none;">{{ longest_streak }}</div>
        <div class="stat-label" style="color: rgba(255,255,255,0.95);">Meilleure série</div>
    </div>
</div>

<!-- Sentiment Timeline Chart (Full Width) -->
<div class="chart-container" style="margin-bottom: 2rem;">
    <h3 class="chart-title">📈 Évolution des émotions (30 derniers jours)</h3>
    <canvas id="sentimentChart" style="max-height: 300px;"></canvas>
</div>

<!-- Charts Row -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
    <!-- Tags Chart -->
    <div class="chart-container">
        <h3 class="chart-title">🏷️ Tags les plus utilisés</h3>
        <canvas id="tagsChart"></canvas>
    </div>
    
    <!-- Moods Chart -->
    <div class="chart-container">
        <h3 class="chart-title">😊 Humeurs les plus fréquentes</h3>
        <canvas id="moodsChart"></canvas>
    </div>
</div>

<!-- Top Lists -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
    <!-- Top Tags List -->
    <div class="chart-container">
        <h3 class="chart-title">🏆 Top 10 Tags</h3>
        {% if tags_populaires %}
        <ul class="top-list">
            {% for tag in tags_populaires %}
            <li class="top-list-item">
                <div style="display: flex; align-items: center;">
                    <span class="rank {% if forloop.counter == 1 %}gold{% elif forloop.counter == 2 %}silver{% elif forloop.counter == 3 %}bronze{% endif %}">
                        #{{ forloop.counter }}
                    </span>
                    <span class="tag-badge" style="background-color: {{ tag.couleur }}20; color: {{ tag.couleur }}; border: 1px solid {{ tag.couleur }}; padding: 0.25rem 0.75rem; border-radius: 12px;">
                        {{ tag.nom }}
                    </span>
                </div>
                <span style="font-weight: bold; color: #3b82f6;">{{ tag.nb_utilisations }} fois</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p style="text-align: center; color: #6b7280; padding: 2rem;">Aucun tag utilisé pour le moment</p>
        {% endif %}
    </div>
    
    <!-- Top Moods List -->
    <div class="chart-container">
        <h3 class="chart-title">🎭 Top 10 Humeurs</h3>
        {% if humeurs_frequentes %}
        <ul class="top-list">
            {% for humeur in humeurs_frequentes %}
            <li class="top-list-item">
                <div style="display: flex; align-items: center;">
                    <span class="rank {% if forloop.counter == 1 %}gold{% elif forloop.counter == 2 %}silver{% elif forloop.counter == 3 %}bronze{% endif %}">
                        #{{ forloop.counter }}
                    </span>
                    <span style="font-size: 1.2rem;">{{ humeur.emoji }} {{ humeur.nom }}</span>
                </div>
                <span style="font-weight: bold; color: #3b82f6;">{{ humeur.nb_utilisations }} fois</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p style="text-align: center; color: #6b7280; padding: 2rem;">Aucune humeur enregistrée pour le moment</p>
        {% endif %}
    </div>
</div>

<!-- Recent Entries -->
<div class="chart-container" style="margin-top: 2rem;">
    <h3 class="chart-title">📖 Entrées récentes</h3>
    {% if entrees_recentes %}
    <div style="display: flex; flex-direction: column; gap: 1rem;">
        {% for entree in entrees_recentes %}
        <a href="{% url 'core:detail_entree_journal' entree.pk %}" style="text-decoration: none; color: inherit;">
            <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; transition: all 0.2s;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h4 style="font-weight: bold; margin-bottom: 0.5rem;">{{ entree.titre }}</h4>
                        <p style="color: #6b7280; font-size: 0.9rem;">
                            📅 {{ entree.date_creation|date:"d M Y" }} • 📝 {{ entree.nombre_mots }} mots
                        </p>
                    </div>
                    {% if entree.is_favorite %}
                    <span style="font-size: 1.5rem;">⭐</span>
                    {% endif %}
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <p style="text-align: center; color: #6b7280; padding: 2rem;">Aucune entrée pour le moment</p>
    {% endif %}
</div>

</div>
<!-- End of container -->

<script>
// Sentiment Timeline Chart
const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
const sentimentData = {
    labels: [{% for item in timeline_data %}'{{ item.date }}',{% endfor %}],
    datasets: [
        {
            label: 'Émotions Positives',
            data: [{% for item in timeline_data %}{{ item.positive }},{% endfor %}],
            backgroundColor: 'rgba(16, 185, 129, 0.2)',
            borderColor: 'rgba(16, 185, 129, 1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: 'rgba(16, 185, 129, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        },
        {
            label: 'Émotions Négatives',
            data: [{% for item in timeline_data %}{{ item.negative }},{% endfor %}],
            backgroundColor: 'rgba(239, 68, 68, 0.2)',
            borderColor: 'rgba(239, 68, 68, 1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: 'rgba(239, 68, 68, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        },
        {
            label: 'Nombre d\'entrées',
            data: [{% for item in timeline_data %}{{ item.entries }},{% endfor %}],
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderColor: 'rgba(102, 126, 234, 1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            pointRadius: 3,
            pointHoverRadius: 5,
            pointBackgroundColor: 'rgba(102, 126, 234, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            borderDash: [5, 5]
        }
    ]
};

new Chart(sentimentCtx, {
    type: 'line',
    data: sentimentData,
    options: {
        responsive: true,
        maintainAspectRatio: true,
        interaction: {
            mode: 'index',
            intersect: false
        },
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    font: { size: 13, weight: '600' },
                    color: '#64748b',
                    padding: 15,
                    usePointStyle: true,
                    pointStyle: 'circle'
                }
            },
            tooltip: {
                backgroundColor: 'rgba(102, 126, 234, 0.95)',
                padding: 16,
                titleFont: { size: 15, weight: 'bold' },
                bodyFont: { size: 13 },
                cornerRadius: 12,
                displayColors: true,
                callbacks: {
                    title: function(context) {
                        return 'Date: ' + context[0].label;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    font: { size: 12, weight: '600' },
                    color: '#64748b'
                },
                grid: {
                    color: 'rgba(102, 126, 234, 0.08)',
                    lineWidth: 1
                }
            },
            x: {
                ticks: {
                    font: { size: 11, weight: '600' },
                    color: '#64748b',
                    maxRotation: 45,
                    minRotation: 45
                },
                grid: {
                    display: false
                }
            }
        },
        animation: {
            duration: 2000,
            easing: 'easeInOutQuart'
        }
    }
});

// Tags Chart
const tagsCtx = document.getElementById('tagsChart').getContext('2d');
const tagsData = {
    labels: [{% for tag in tags_populaires|slice:":5" %}'{{ tag.nom }}',{% endfor %}],
    datasets: [{
        label: 'Utilisations',
        data: [{% for tag in tags_populaires|slice:":5" %}{{ tag.nb_utilisations }},{% endfor %}],
        backgroundColor: [
            {% for tag in tags_populaires|slice:":5" %}'{{ tag.couleur }}40',{% endfor %}
        ],
        borderColor: [
            {% for tag in tags_populaires|slice:":5" %}'{{ tag.couleur }}',{% endfor %}
        ],
        borderWidth: 2
    }]
};

new Chart(tagsCtx, {
    type: 'bar',
    data: tagsData,
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(102, 126, 234, 0.95)',
                padding: 16,
                titleFont: { size: 16, weight: 'bold' },
                bodyFont: { size: 14 },
                cornerRadius: 12,
                displayColors: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    font: { size: 13, weight: '600' },
                    color: '#64748b'
                },
                grid: {
                    color: 'rgba(102, 126, 234, 0.08)',
                    lineWidth: 1
                }
            },
            x: {
                ticks: {
                    font: { size: 13, weight: '600' },
                    color: '#64748b'
                },
                grid: {
                    display: false
                }
            }
        },
        animation: {
            duration: 1500,
            easing: 'easeInOutQuart'
        }
    }
});

// Moods Chart
const moodsCtx = document.getElementById('moodsChart').getContext('2d');
const moodsData = {
    labels: [{% for humeur in humeurs_frequentes|slice:":5" %}'{{ humeur.emoji }} {{ humeur.nom }}',{% endfor %}],
    datasets: [{
        label: 'Fréquence',
        data: [{% for humeur in humeurs_frequentes|slice:":5" %}{{ humeur.nb_utilisations }},{% endfor %}],
        backgroundColor: [
            {% for humeur in humeurs_frequentes|slice:":5" %}'{{ humeur.couleur }}40',{% endfor %}
        ],
        borderColor: [
            {% for humeur in humeurs_frequentes|slice:":5" %}'{{ humeur.couleur }}',{% endfor %}
        ],
        borderWidth: 2
    }]
};

new Chart(moodsCtx, {
    type: 'doughnut',
    data: moodsData,
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    font: { size: 14, weight: '600' },
                    color: '#64748b',
                    padding: 20,
                    usePointStyle: true,
                    pointStyle: 'circle'
                }
            },
            tooltip: {
                backgroundColor: 'rgba(102, 126, 234, 0.95)',
                padding: 16,
                titleFont: { size: 16, weight: 'bold' },
                bodyFont: { size: 14 },
                cornerRadius: 12,
                displayColors: true
            }
        },
        cutout: '65%',
        animation: {
            duration: 1800,
            easing: 'easeInOutQuart',
            animateRotate: true,
            animateScale: true
        }
    }
});

// Export to PDF function
function exportToPDF() {
    // Show loading
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '⏳ Génération en cours...';
    btn.disabled = true;
    
    // Call export endpoint
    fetch('/journal/export-pdf/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.blob())
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'mon-journal-' + new Date().toISOString().split('T')[0] + '.pdf';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Reset button
        btn.innerHTML = originalText;
        btn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de l\'export PDF. Veuillez réessayer.');
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}
</script>
{% endblock %}

{% extends 'core/dashboard_base.html' %}
{% load static %}

{% block title %}Mood Analysis{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1 style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">üé≠ Mood Analysis</h1>
    <p style="color: var(--text-gray); font-size: 1.1rem;">Analyze your emotions with AI-powered insights</p>
</div>

<!-- Analysis Form -->
<div class="card">
    <h2 class="card-title">How are you feeling today?</h2>
    <form method="post">
        {% csrf_token %}
        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-gray); font-size: 0.95rem;">Describe your current mood, thoughts, or how your day went...</label>
        <textarea name="text" rows="5" style="width: 100%; border: 2px solid var(--border-color); padding: 1rem; margin-bottom: 1rem; font-size: 1rem; font-family: inherit;" placeholder="I'm feeling..."></textarea>
        <button type="submit" class="btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">‚ú® Analyze with AI</button>
    </form>
</div>

<!-- Analysis Result -->
{% if result %}
<div class="card" style="background: linear-gradient(135deg, #faf6f1 0%, #f5ebe0 100%); border: 3px solid var(--accent-orange); position: relative; overflow: hidden;">
    <!-- Decorative corner accent -->
    <div style="position: absolute; top: 0; right: 0; width: 80px; height: 80px; background: linear-gradient(135deg, var(--accent-orange) 0%, transparent 100%); opacity: 0.1;"></div>
    
    <div style="position: relative; z-index: 1;">
        <h2 style="font-size: 1.75rem; font-weight: bold; margin-bottom: 1rem; color: var(--text-dark); display: flex; align-items: center; gap: 0.5rem;">
            <span style="color: var(--accent-orange);">üé≠</span> Analysis Result
        </h2>
        
        <div style="background: rgba(255, 107, 53, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border-left: 4px solid var(--accent-orange);">
            <p style="font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--text-gray); opacity: 0.9;">Detected Mood:</p>
            <p style="font-size: 2.5rem; font-weight: bold; color: var(--accent-orange); text-transform: capitalize; margin: 0;">{{ result.top }}</p>
        </div>
        
        {% if recommendation %}
        <div style="background: rgba(212, 197, 185, 0.1); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--separator-color); margin-bottom: 1.5rem;">
            <p style="font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--text-dark); font-weight: bold; display: flex; align-items: center; gap: 0.5rem;">
                <span>üí°</span> Personalized Recommendation:
            </p>
            <p style="font-size: 1rem; line-height: 1.6; color: var(--text-gray); margin: 0;">{{ recommendation }}</p>
        </div>
        {% endif %}
        
        {% if music_recommendation %}
        <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); padding: 1.5rem; border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.2); position: relative; overflow: hidden;">
            <!-- Musical note decoration -->
            <div style="position: absolute; top: -10px; right: -10px; font-size: 80px; opacity: 0.05; transform: rotate(15deg);">üéµ</div>
            
            <div style="position: relative; z-index: 1;">
                <p style="font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--text-dark); font-weight: bold; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üéµ</span> Recommended Music for Your Mood:
                </p>
                
                <div style="background: white; padding: 1.25rem; border-radius: 8px; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <p style="font-size: 0.85rem; color: var(--text-gray); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">
                        <span style="display: inline-block; width: 8px; height: 8px; background: #667eea; border-radius: 50%; margin-right: 6px;"></span>
                        {{ music_recommendation.emotion }}
                    </p>
                    <p style="font-size: 1.25rem; font-weight: bold; color: #667eea; margin: 0.5rem 0;">
                        {{ music_recommendation.suggestion }}
                    </p>
                    <p style="font-size: 0.95rem; line-height: 1.5; color: var(--text-gray); margin: 0;">
                        {{ music_recommendation.description }}
                    </p>
                </div>
                
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <a href="https://www.youtube.com/results?search_query={{ music_recommendation.suggestion|urlencode }}" 
                       target="_blank"
                       style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: #FF0000; color: white; text-decoration: none; border-radius: 8px; font-size: 0.9rem; font-weight: 500; transition: transform 0.2s ease, box-shadow 0.2s ease;"
                       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(255,0,0,0.3)';"
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                        <span style="font-size: 1.1rem;">‚ñ∂Ô∏è</span> Listen on YouTube
                    </a>
                    
                    <a href="https://open.spotify.com/search/{{ music_recommendation.suggestion|urlencode }}" 
                       target="_blank"
                       style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: #1DB954; color: white; text-decoration: none; border-radius: 8px; font-size: 0.9rem; font-weight: 500; transition: transform 0.2s ease, box-shadow 0.2s ease;"
                       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(29,185,84,0.3)';"
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                        <span style="font-size: 1.1rem;">üéß</span> Listen on Spotify
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if result.scores %}
        <div style="margin-top: 1.5rem;">
            <p style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark); font-weight: bold; display: flex; align-items: center; gap: 0.5rem;">
                <span>üìä</span> Emotion Scores:
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                {% for k, v in result.scores.items %}
                <div style="background: var(--panel-bg); padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid var(--separator-color); transition: transform 0.2s ease;">
                    <p style="font-size: 0.85rem; color: var(--text-gray); margin-bottom: 0.25rem; text-transform: capitalize; font-weight: 500;">{{ k }}</p>
                    <p style="font-size: 1.5rem; font-weight: bold; color: var(--accent-orange); margin: 0;">{{ v|floatformat:2 }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Statistics Section -->
{% if mood_stats_json or daily_moods_json %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    
    <!-- Mood Distribution Chart -->
    {% if mood_stats_json %}
    <div class="card">
        <h2 class="card-title">üìà Mood Distribution (Last 30 Days)</h2>
        <canvas id="moodDistributionChart" style="max-height: 300px;"></canvas>
    </div>
    {% endif %}
    
    <!-- Weekly Trend Chart -->
    {% if daily_moods_json %}
    <div class="card">
        <h2 class="card-title">üìä Weekly Positivity Trend (Last 14 Days)</h2>
        <div style="position: relative;">
            <canvas id="weeklyTrendChart" style="max-height: 300px;"></canvas>
            <div id="noDataMessage" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--text-gray); display: none;">
                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">üìä No mood data in the last 14 days</p>
                <p style="font-size: 0.9rem;">Analyze your mood above to see trends!</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Recent Analyses -->
<div class="card">
    <h2 class="card-title">üìù Recent Analyses</h2>
    {% if history %}
    <div style="display: flex; flex-direction: column; gap: 1rem;">
        {% for h in history %}
        <div style="border: 2px solid var(--border-color); padding: 1.25rem; background: white;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                <span style="font-weight: bold; font-size: 1.1rem; text-transform: capitalize; color: var(--accent-orange);">{{ h.top }}</span>
                <span style="font-size: 0.85rem; color: var(--text-gray);">{{ h.created_at|date:"d/m/Y H:i" }}</span>
            </div>
            <p style="color: var(--text-gray); font-size: 0.95rem; line-height: 1.5;">{{ h.text|truncatechars:200 }}</p>
            <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-gray); opacity: 0.7;">
                <span>Source: {{ h.source|upper }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem; color: var(--text-gray);">
        <p style="font-size: 1.1rem; margin-bottom: 1rem;">No analyses yet</p>
        <p style="font-size: 0.95rem;">Start by analyzing your mood above!</p>
    </div>
    {% endif %}
</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Mood Distribution Chart
{% if mood_stats_json %}
const moodData = {{ mood_stats_json|safe }};
const moodLabels = moodData.map(item => item.top.charAt(0).toUpperCase() + item.top.slice(1));
const moodCounts = moodData.map(item => item.count);

const moodColors = {
    'Positif': '#10b981',
    'Neutre': '#6b7280',
    'Negatif': '#ef4444',
    'Colere': '#f59e0b',
    'Tristesse': '#3b82f6'
};

const backgroundColors = moodLabels.map(label => moodColors[label] || '#667eea');

new Chart(document.getElementById('moodDistributionChart'), {
    type: 'doughnut',
    data: {
        labels: moodLabels,
        datasets: [{
            data: moodCounts,
            backgroundColor: backgroundColors,
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    font: {
                        size: 13,
                        family: "'Inter', sans-serif"
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed + ' analyses';
                    }
                }
            }
        }
    }
});
{% endif %}

// Weekly Trend Chart
{% if daily_moods_json %}
console.log('üü¶ Weekly Trend Chart - Starting');
const dailyData = {{ daily_moods_json|safe }};
console.log('üìä dailyData:', dailyData);

const dailyLabels = dailyData.map(item => item.date);
const dailyPositivity = dailyData.map(item => item.positivity);

console.log('üè∑Ô∏è  dailyLabels:', dailyLabels);
console.log('üìà dailyPositivity:', dailyPositivity);

// Check if there's any data
const hasData = dailyPositivity.some(value => value !== null);
console.log('‚úÖ hasData:', hasData);

if (!hasData) {
    console.log('‚ö†Ô∏è No data found - showing message');
    document.getElementById('noDataMessage').style.display = 'block';
    document.getElementById('weeklyTrendChart').style.opacity = '0.3';
} else {
    console.log('‚úÖ Data found - creating chart');
}

try {
    const chart = new Chart(document.getElementById('weeklyTrendChart'), {
    type: 'line',
    data: {
        labels: dailyLabels,
        datasets: [{
            label: 'Positivity Score',
            data: dailyPositivity,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 6,
            pointBackgroundColor: '#667eea',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverRadius: 8,
            spanGaps: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'Score: ' + context.parsed.y.toFixed(2);
                    }
                }
            }
        },
        scales: {
            y: {
                suggestedMin: -1,
                suggestedMax: 1,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: {
                        family: "'Inter', sans-serif"
                    },
                    callback: function(value) {
                        return value.toFixed(1);
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        family: "'Inter', sans-serif"
                    }
                }
            }
        }
    }
});
    console.log('‚úÖ Chart created successfully!');
} catch (error) {
    console.error('‚ùå Error creating chart:', error);
    document.getElementById('noDataMessage').innerHTML = '<p style="font-size: 1.1rem; color: red;">‚ùå Error creating chart</p><p style="font-size: 0.9rem;">' + error.message + '</p>';
    document.getElementById('noDataMessage').style.display = 'block';
}
{% endif %}
</script>
{% endblock %}
